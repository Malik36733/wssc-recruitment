<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>WSSC Recruitment â€” Local</title>

<!-- SheetJS for Excel export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<!-- SweetAlert2 for modern popups -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- jsPDF for PDF export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore.js"></script>
<script src="firebase-config.js"></script>
<script src="firebase-functions.js"></script>
<!-- Initialize Firebase and Setup Realtime -->
<script>
    // Initialize when document loads
    document.addEventListener('DOMContentLoaded', function() {
        loadFromFirebase().then(() => {
            setupRealtimeListener();
        });
    });
</script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap');
:root{
  --brand:#1565c0; --brand-dark:#0d47a1; --bg:#f3f7fb; --card:#ffffff; --muted:#6b7a90;
  --radius:14px;
  --glass: rgba(255,255,255,0.6);
  --glass-border: rgba(255,255,255,0.5);
  --soft-shadow: 0 10px 30px rgba(6,30,60,0.06);
  --container-gap:18px;
}
*{box-sizing:border-box}
body{margin:0;font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, Arial;background:linear-gradient(180deg,#f2f7ff,#f8fbff);color:#08303f}

/* Glass base */
.panel, .card, .chartCard, .insightCard, .sidebar{
  background: linear-gradient(180deg, rgba(255,255,255,0.75), rgba(255,255,255,0.6));
  border-radius: var(--radius);
  border: 1px solid rgba(255,255,255,0.5);
  box-shadow: var(--soft-shadow);
  backdrop-filter: blur(8px) saturate(120%);
}

/* Consistent spacing */
.container{gap:var(--container-gap)}
.card, .chartCard, .insightCard{padding:18px}
.titleBlock .big{font-size:18px}
.titleBlock .small{font-size:12px}

/* Login */
#loginScreen{min-height:100vh;display:flex;align-items:center;justify-content:center}
.loginCard{width:420px;background:var(--card);padding:28px;border-radius:14px;box-shadow:0 20px 50px rgba(6,30,60,0.08);text-align:center}
.logoCircle{width:84px;height:84px;border-radius:14px;margin:0 auto;background:linear-gradient(180deg,var(--brand),var(--brand-dark));display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800;font-size:28px}
/* If you'd like to show actual logo image instead of "W", put LOGO.PNG in same folder and uncomment the <img> usage in the login HTML below */
.loginCard h2{margin:12px 0 6px;color:var(--brand-dark)}
.loginCard .input{width:100%;padding:10px;border-radius:10px;border:1px solid #e6f3ff;margin:8px 0;font-size:14px}
.loginBtn{width:100%;padding:10px;border-radius:10px;border:none;background:linear-gradient(180deg,var(--brand),var(--brand-dark));color:#fff;font-weight:700;cursor:pointer}
.loginErr{color:#c62828;font-weight:700;display:none;margin-top:8px}

/* App layout */
#app{display:none;min-height:100vh}
.topbar{height:68px;background:rgba(255,255,255,0.9);backdrop-filter: blur(4px);display:flex;align-items:center;justify-content:space-between;padding:10px 20px;border-bottom:1px solid rgba(13,40,80,0.06)}
.topLeft{display:flex;align-items:center;gap:12px}
.logoSmall{width:54px;height:54px;border-radius:10px;background:linear-gradient(180deg,var(--brand),var(--brand-dark));display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800}
.titleBlock{line-height:1}
.titleBlock .big{font-weight:900;color:#0b2a45}
.titleBlock .small{font-size:12px;color:var(--muted)}
.topRight{display:flex;align-items:center;gap:8px}
.btn{padding:8px 12px;border-radius:10px;border:1px solid transparent;background:#fff;cursor:pointer}
.btn.primary{background:linear-gradient(180deg,var(--brand),var(--brand-dark));color:#fff;border:none}
.btn.outline{background:#fff;border:1px solid rgba(13,40,80,0.06);color:var(--brand-dark)}
.btn.danger{background:#fff;border:1px solid #ffcdd2;color:#c62828}

/* Animations & transitions */
.fade-in{animation:fadeInPanel 280ms ease-in-out}
@keyframes fadeInPanel{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}

/* Hover & interactive tweaks */
.navItem:hover{transform:translateX(2px);transition:transform .18s}
.btn{transition:all .18s ease}
.btn:hover{transform:translateY(-2px);box-shadow:0 6px 18px rgba(6,30,60,0.08)}
.card, .chartCard, .insightCard, .box{transition:box-shadow .18s, transform .18s}
.card:hover, .chartCard:hover, .insightCard:hover, .box:hover{transform:translateY(-6px);box-shadow:0 18px 40px rgba(6,30,60,0.08)}

/* Dark mode variables */
:root.dark{
  --bg: #0b1220;
  --card: #071126;
  --brand-dark: #90caf9;
  --brand: #42a5f5;
  --muted: #9aa6b2;
  --text: #e6eef6;
}
body.dark{background:linear-gradient(180deg,#071227,#071126);color:var(--text)}
.dark .panel, .dark .card, .dark .chartCard, .dark .insightCard, .dark .sidebar{background:var(--card)}
.dark .topbar{background:rgba(7,17,38,0.85)}
.dark .navItem{color:var(--text)}

/* Sidebar collapsed on small screens */
.sidebar.collapsed{width:64px}
.sidebar.collapsed .navItem{padding-left:8px;font-size:12px}
.container.sidebar-collapsed{margin-left:64px}

/* main layout */
.container{display:flex;gap:8px;/* tighter gap */max-width:calc(100% - 200px);margin:18px 18px 18px 200px;padding:0 12px}
/* Dark background headings for Applicants sections */
#panel-dashboard h3:not(.chartCard h3):not(.insightsSection h3) {
  background: #071126;
  color: white;
  padding: 10px 16px;
  border-radius: var(--radius);
  margin: 20px 0 12px;
  font-size: 15px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}
.sidebar{width:200px;background:rgba(255,255,255,0.8);padding:12px;border-radius:12px;box-shadow:0 10px 30px rgba(6,30,60,0.04);backdrop-filter: blur(4px);position:fixed;left:0;top:68px;bottom:0;overflow:auto}
.navItem{padding:10px;border-radius:10px;margin-bottom:8px;cursor:pointer;font-weight:700;color:var(--brand-dark)}
.navItem.active{background:linear-gradient(180deg,#f2f9ff,#fff);box-shadow:0 6px 20px rgba(13,40,80,0.03)}
.smallMuted{font-size:13px;color:var(--muted);margin-top:10px}

/* dashboard */
.main{flex:1;margin-left:0;padding:8px 12px}
/* Analytics Section */
.analyticsSection {
  margin-bottom: 20px;
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 14px;
}
.chartCard {
  background: linear-gradient(180deg,#fff,#f7fbff);
  padding: 16px;
  border-radius: 12px;
  box-shadow: 0 10px 30px rgba(6,30,60,0.04);
  position: relative;
  min-height: 300px;
}
.chartCard h3 {
  margin: 0 0 12px 0;
  color: var(--brand-dark);
  font-size: 14px;
}
.chartWrapper {
  position: relative;
  height: 250px;
  width: 100%;
}
/* Dashboard Cards */
.cardsRow{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;margin-bottom:14px}
.card{background:linear-gradient(180deg,#fff,#f7fbff);padding:14px;border-radius:12px;box-shadow:0 10px 30px rgba(6,30,60,0.04)}
.card h3{margin:0;font-size:13px;color:var(--brand-dark)}
.card p{margin:8px 0 0;font-size:20px;font-weight:900;color:#0b2a45}

/* filters */
.filters{display:flex;gap:10px;align-items:center;margin-bottom:12px;flex-wrap:wrap}
.select, input[type="text"]{padding:8px;border-radius:8px;border:1px solid #e6f3ff;background:#fff}

/* UC/pos grid */
.grid{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:24px;padding:20px;border-radius:var(--radius);background:linear-gradient(180deg, rgba(255,255,255,0.9), rgba(247,251,255,0.8));backdrop-filter:blur(8px);box-shadow:0 10px 30px rgba(6,30,60,0.06)}
.box{min-width:160px;background:rgba(255,255,255,0.95);padding:12px;border-radius:10px;box-shadow:0 8px 24px rgba(6,30,60,0.04);cursor:pointer;transition:all 0.2s ease}
.box:hover{transform:translateY(-4px);box-shadow:0 12px 30px rgba(6,30,60,0.08)}
.box h4{margin:0;color:#0b3d63}
.box p{margin:6px 0 0;font-weight:800;color:#0b2a45}

/* Insights Section */
.insightsSection {
  margin-top: 24px;
  padding-top: 20px;
  border-top: 1px solid rgba(13,40,80,0.08);
}
.insightsSection h3 {
  margin: 0 0 16px 0;
  color: var(--brand-dark);
  font-size: 16px;
}
.insightsGrid {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 14px;
}
.insightCard {
  background: linear-gradient(180deg,#fff,#f7fbff);
  padding: 16px;
  border-radius: 12px;
  box-shadow: 0 10px 30px rgba(6,30,60,0.04);
  text-align: center;
}
.insightCard .label {
  color: var(--muted);
  font-size: 13px;
  margin-bottom: 8px;
}
.insightCard .value {
  color: var(--brand-dark);
  font-size: 18px;
  font-weight: 800;
  margin-bottom: 4px;
}
.insightCard .subtext {
  color: var(--brand);
  font-size: 12px;
  font-weight: 600;
}

/* Make insights responsive */
@media (max-width: 1200px) {
  .insightsGrid {
    grid-template-columns: repeat(3, 1fr);
  }
}
@media (max-width: 768px) {
  .insightsGrid {
    grid-template-columns: repeat(2, 1fr);
  }
}

/* panels */
.panel{background:rgba(255,255,255,0.92);padding:14px;border-radius:12px;box-shadow:0 12px 40px rgba(6,30,60,0.06)}
.hide{display:none}

/* form grid */
.formGrid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
.formGrid .full{grid-column:1 / -1}
.label{font-weight:800;color:#174064;margin-bottom:6px}
.field{display:flex;align-items:center;border-radius:10px;border:1px solid #e6f3ff;padding:8px;background:#fff}
.field input, .field select, .field textarea{border:0;outline:0;width:100%;font-size:14px}
.actions{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}

/* Neumorphism inputs */
.field{background:linear-gradient(180deg,#fbfdff,#f3f7fb);box-shadow: inset 6px 6px 12px rgba(0,0,0,0.03), inset -6px -6px 12px rgba(255,255,255,0.6)}
.btn{border-radius:12px}

/* Table refinements */
table{background:transparent}
thead th{background:linear-gradient(180deg,var(--brand),var(--brand-dark));box-shadow:0 6px 14px rgba(13,40,80,0.08)}
tbody td{background:linear-gradient(180deg, rgba(255,255,255,0.6), rgba(250,250,250,0.6));border-radius:8px;margin:4px;}

/* table */
.tableWrap{
  overflow:auto;
  margin-top:6px;
  border-radius:8px;
  max-height: calc(100vh - 240px);
  position: relative;
}
table{
  width:100%;
  border-collapse:collapse;
  font-size: 13px;
  table-layout: fixed;
}
thead th{
  background:linear-gradient(180deg,var(--brand),var(--brand-dark));
  color:#fff;
  padding:6px 4px;
  position:sticky;
  top:0;
  z-index:10;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
tbody td{
  padding:4px 6px;
  border-bottom:1px solid #eef6ff;
  text-align:center;
  white-space:normal;
  word-wrap:break-word;
  vertical-align:middle;
  line-height:1.3;
}
tbody tr:hover{background:#fbfdff}
/* Optimized column widths */
table th:nth-child(1){width:40px} /* S.No */
table th:nth-child(2){width:80px} /* App No */
table th:nth-child(3){width:120px} /* Name */
table th:nth-child(4){width:120px} /* Father */
table th:nth-child(5){width:40px} /* Age */
table th:nth-child(6){width:100px} /* CNIC */
table th:nth-child(7){width:80px} /* UC/Tehsil */
table th:nth-child(8){width:60px} /* Extra */
table th:nth-child(9){width:90px} /* Contact */
table th:nth-child(10){width:50px} /* Exp */
table th:nth-child(11){width:100px} /* Education */
table th:nth-child(12){width:140px} /* Address */
table th:nth-child(13){width:70px} /* Date */
table th:nth-child(14){width:120px} /* Status */
table th:nth-child(15){width:100px} /* Actions */

/* Responsive adjustments */
@media (max-width: 1200px) {
  .tableWrap { font-size: 12px; }
  tbody td { padding: 3px 4px; }
  table th:nth-child(12) { width: 120px; } /* Address */
}
/* Button adjustments in table */
.tableWrap .btn {
  padding: 4px 8px;
  font-size: 12px;
  margin: 2px;
  white-space: nowrap;
}
.navItem:hover, .statusBtn:hover{background:#f6fbff}

/* modal (simple) */
.modalBack{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(6,14,30,0.45);z-index:60}
.modal{width:860px;background:#fff;border-radius:12px;padding:16px;box-shadow:0 30px 80px rgba(6,30,60,0.28)}
.confirmRow{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}

/* status row colors and indicators */
.status-pending {
  background: #ffffff;
  border-left: 4px solid #9e9e9e;
}
.status-shortlisted {
  background: #fff8e1;
  border-left: 4px solid #ffc107;
}
.status-selected {
  background: #e8f5e9;
  border-left: 4px solid #4caf50;
}
.status-rejected {
  background: #ffebee;
  border-left: 4px solid #f44336;
}
.row-selected {
  outline: 2px solid rgba(21,101,192,0.2);
}

/* Status badge styles */
.status-badge {
  padding: 4px 8px;
  border-radius: 12px;
  font-size: 12px;
  font-weight: 600;
  display: inline-block;
  min-width: 90px;
}
.status-badge.pending {
  background: #f5f5f5;
  color: #616161;
}
.status-badge.shortlisted {
  background: #fff8e1;
  color: #ff8f00;
}
.status-badge.selected {
  background: #e8f5e9;
  color: #2e7d32;
}
.status-badge.rejected {
  background: #ffebee;
  color: #c62828;
}

/* small status filter buttons in sidebar */
.statusBtn{display:block;padding:8px 10px;border-radius:8px;margin:6px 0;background:#fff;border:1px solid rgba(13,40,80,0.04);cursor:pointer;font-weight:700;color:var(--brand-dark);text-align:left}
.statusBtn.active{background:linear-gradient(180deg,#f2f9ff,#fff);box-shadow:0 6px 20px rgba(13,40,80,0.03)}

/* responsive */
@media (max-width:1000px){
  .cardsRow{grid-template-columns:repeat(2,1fr)}
  .formGrid{grid-template-columns:repeat(2,1fr)}
  .sidebar{display:none}
  /* restore container margin when sidebar hidden */
  .container{margin-left:18px;max-width:100%;padding:0 12px}
  .main{margin-left:0}
}
@media (max-width:600px){
  .cardsRow{grid-template-columns:1fr}
  .formGrid{grid-template-columns:1fr}
}
.smallNote{font-size:13px;color:var(--muted);margin-top:8px}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginScreen">
  <div class="loginCard">
    <div class="logoCircle">W</div>
    <h2>WSSC Recruitment Portal</h2>
    <form id="loginForm" onsubmit="return false;">
      <input id="loginUser" class="input" placeholder="Username" autocomplete="username" />
      <input id="loginPass" class="input" placeholder="Password" type="password" autocomplete="current-password" />
      <div style="height:10px"></div>
      <button id="loginBtn" class="loginBtn">Sign in</button>
    </form>
    <div id="loginError" class="loginErr"></div>
    <p class="smallNote">Contact system admin for account changes.</p>
  </div>
</div>

<!-- APP -->
<div id="app" style="display:none;">
  <div class="topbar">
    <div class="topLeft">
      <div class="logoSmall">W</div>
      <div class="titleBlock">
        <div class="big">WSSC D.I. Khan DASHBOARD</div>
        <div class="small">Water and Sanitation Services Company</div>
      </div>
    </div>
    <div class="topRight">
      <button id="sidebarToggle" class="btn outline" title="Toggle sidebar">â˜°</button>
      <button id="darkModeToggle" class="btn outline" title="Toggle dark mode">ðŸŒ™</button>
      <button id="printBtn" class="btn outline">Print</button>
      <button id="exportBtn" class="btn">Export All</button>
      <button id="logoutBtn" class="btn outline">Logout</button>
    </div>
  </div>

  <div class="container">
    <aside class="sidebar">
      <div id="navDashboard" class="navItem active" onclick="showPanel('dashboard')">Dashboard</div>
      <div id="navAdd" class="navItem" onclick="showPanel('add')">Add Applicant</div>
      <div id="navView" class="navItem" onclick="showPanel('view')">View / Search</div>
      <div id="navExport" class="navItem" onclick="showPanel('export')">Export Reports</div>
      <hr />
      <h4 style="margin:8px 0 6px;color:var(--brand-dark)">Filter by Status</h4>
      <button class="statusBtn active" data-filter="all">All Applicants</button>
      <button class="statusBtn" data-filter="Shortlisted">Shortlisted</button>
      <button class="statusBtn" data-filter="Selected">Selected</button>
      <button class="statusBtn" data-filter="Rejected">Rejected</button>
      <div class="smallMuted">Logged in as <strong>admin</strong></div>
    </aside>

    <main class="main">
      <!-- DASHBOARD -->
      <div id="panel-dashboard" class="panel">
          <!-- Analytics Charts -->
          <div class="analyticsSection">
            <div class="chartCard">
              <h3>Applicants by UC</h3>
              <div class="chartWrapper">
                <canvas id="ucPieChart"></canvas>
              </div>
            </div>
            <div class="chartCard">
              <h3>Applicants by Designation</h3>
              <div class="chartWrapper">
                <canvas id="designationBarChart"></canvas>
              </div>
            </div>
            <div class="chartCard">
              <h3>Applications Over Time</h3>
              <div class="chartWrapper">
                <canvas id="timelineChart"></canvas>
              </div>
            </div>
          </div>
          
          <div class="cardsRow">
            <div class="card"><h3>Total Applicants</h3><p id="totalApplicants">0</p></div>
            <div class="card"><h3>Pending</h3><p id="countPending">0</p></div>
            <div class="card"><h3>Shortlisted</h3><p id="countShortlisted">0</p></div>
            <div class="card"><h3>Selected</h3><p id="countSelected">0</p></div>
            <div class="card"><h3>Rejected</h3><p id="countRejected">0</p></div>
            <div class="card"><h3>Distinct UCs</h3><p id="distinctUCs">0</p></div>
            <div class="card"><h3>Last Submission</h3><p id="lastSubmission">-</p></div>
          </div>

        <div class="filters">
          <select id="dashUc" class="select"><option>All</option></select>
          <select id="dashPos" class="select"><option>All</option></select>
          <button class="btn" id="dashApply">Apply</button>
          <button class="btn outline" id="dashClear">Clear</button>
        </div>

        <h3>Applicants by UC</h3>
        <div id="ucGrid" class="grid"></div>

        <h3>Applicants by Position</h3>
        <div id="posGrid" class="grid"></div>

        <!-- Insights Section -->
        <div class="insightsSection">
          <h3>ðŸ“Š System Insights</h3>
          <div class="insightsGrid">
            <div class="insightCard">
              <div class="label">Most Applied UC</div>
              <div class="value" id="insightTopUC">-</div>
              <div class="subtext" id="insightTopUCCount">0 applicants</div>
            </div>
            <div class="insightCard">
              <div class="label">Common Qualification</div>
              <div class="value" id="insightTopQual">-</div>
              <div class="subtext" id="insightTopQualCount">0 applicants</div>
            </div>
            <div class="insightCard">
              <div class="label">Average Age</div>
              <div class="value" id="insightAvgAge">-</div>
              <div class="subtext" id="insightAgeRange">No data</div>
            </div>
            <div class="insightCard">
              <div class="label">Highest Experience</div>
              <div class="value" id="insightMaxExp">-</div>
              <div class="subtext" id="insightExpPos">No data</div>
            </div>
            <div class="insightCard">
              <div class="label">Trending Designation</div>
              <div class="value" id="insightTrending">-</div>
              <div class="subtext" id="insightTrendingCount">0 recent applications</div>
            </div>
          </div>
        </div>
      </div>

      <!-- ADD -->
      <div id="panel-add" class="panel hide">
        <h3>Add / Edit Applicant</h3>
        <form id="appForm" class="formGrid" onsubmit="return false;">
          <div>
            <div class="label">Designation</div>
            <div class="field">
              <select id="fPosition"></select>
            </div>
          </div>

          <div>
            <!-- dynamic label: UC or Tehsil -->
            <div class="label" id="ucLabel">UC</div>
            <div class="field">
              <!-- default select (we will show/hide or populate depending on position) -->
              <select id="fUC"></select>
              <!-- fixed readonly input for Tehsil (hidden by default) -->
              <input id="fUC_fixed" style="display:none" readonly />
            </div>
          </div>

          <div>
            <div class="label">Application No. (auto)</div>
            <div class="field">
              <input id="fAppNo" readonly />
            </div>
          </div>

          <div>
            <div class="label">Name</div>
            <div class="field"><input id="fName" required></div>
          </div>

          <div>
            <div class="label">Father Name</div>
            <div class="field"><input id="fFather" required></div>
          </div>

          <div>
            <div class="label">CNIC</div>
            <div class="field"><input id="fCnic" required placeholder="xxxxx-xxxxxxx-x" maxlength="15"></div>
          </div>

          <div>
            <div class="label">Contact</div>
            <div class="field"><input id="fContact" placeholder="0344-1234567" maxlength="12"></div>
          </div>

          <div>
            <div class="label">Age</div>
            <div class="field">
              <select id="fAge"></select>
            </div>
          </div>

          <div>
            <div class="label">Experience (years)</div>
            <div class="field">
              <select id="fExp"></select>
            </div>
          </div>

          <div>
            <div class="label" id="eduLabel">Education</div>
            <div class="field">
              <!-- normal dropdown -->
              <select id="fEdu"></select>
              <!-- manual input for Supervisor (hidden by default) -->
              <input id="fEdu_manual" style="display:none" placeholder="Enter Education Manually" />
            </div>
            <!-- Mechanic diploma dropdown and specialty box (hidden by default) -->
            <div id="mechanicDiplomaWrap" style="width:100%;margin-top:8px;display:none">
              <div class="label">Diploma (years)</div>
              <div class="field" style="margin-bottom:8px">
                <select id="fDiplomaYears">
                  <option value="">Select Years</option>
                  <option>1 Year</option>
                  <option>2 Years</option>
                  <option>3 Years</option>
                </select>
              </div>
              <div class="label">Specialty</div>
              <div class="field"><input id="fDiplomaSpec" placeholder="e.g. Auto Mobile, Mechanical etc." /></div>
            </div>
          </div>

          <div class="full">
            <div class="label">Permanent Address</div>
            <div class="field"><textarea id="fAddr" rows="2"></textarea></div>
          </div>

          <div>
            <div class="label">Date of Submission</div>
            <div class="field"><input id="fDate" readonly></div>
          </div>

          <div>
            <div class="label">Remarks</div>
            <div class="field"><input id="fRemarks"></div>
          </div>

          <div>
            <div class="label">Status</div>
            <div class="field">
              <select id="fStatus">
                <option value="Pending">Pending</option>
                <option value="Shortlisted">Shortlisted</option>
                <option value="Selected">Selected</option>
                <option value="Rejected">Rejected</option>
              </select>
            </div>
          </div>

          <div id="fExtra" class="full"></div>

          <div class="full actions">
            <button id="saveBtn" class="btn primary">Save</button>
            <button id="cancelBtn" class="btn outline">Cancel</button>
          </div>
          <div id="formMsg" class="full smallNote" style="color:#c62828;display:none"></div>
        </form>
      </div>

      <!-- VIEW -->
      <div id="panel-view" class="panel hide">
        <div style="display:flex;align-items:center;gap:8px">
          <h3 id="viewHeading">View / Search Applicants</h3>
          <span id="filterSpinner" class="spinner hide" title="Applying filters"></span>
        </div>
        <div class="filters" style="margin-bottom:10px;">
          <select id="viewUc" class="select"><option>All</option></select>
          <select id="viewPos" class="select"><option>All</option></select>
          <input id="searchInput" type="text" placeholder="Search (Name or CNIC)" style="padding:8px;border-radius:8px;border:1px solid #e6f3ff">
          <button id="exportFilteredBtn" class="btn">Export Filtered</button>
          <button id="printFilteredBtn" class="btn outline">Print</button>
        </div>
        <div id="tableContainer" class="tableWrap"><!-- table inserted here --></div>
      </div>

      <!-- EXPORT -->
      <div id="panel-export" class="panel hide">
        <h3>Export Reports</h3>
        <p class="smallMuted">Export All creates sheets for each UC+Designation that has data.</p>
        <div style="margin-top:10px">
          <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
            <button id="exportAllBtn" class="btn primary">Export All (UC+Designation)</button>
            <button id="backupBtn" class="btn outline">Backup (JSON)</button>
            <button id="restoreBtn" class="btn outline">Restore (JSON)</button>
            <button id="exportPdfBtn" class="btn">Export Filtered PDF</button>
            <input id="restoreInput" type="file" accept="application/json" style="display:none" />
          </div>
        </div>
      </div>

    </main>
  </div>
</div>

<!-- Delete Auth Modal -->
<div id="deleteModal" class="modalBack">
  <div class="modal">
    <h3>Confirm Delete (Admin)</h3>
    <p class="smallNote">Enter delete credentials to permanently remove this record.</p>
    <div style="display:flex;flex-direction:column;gap:8px;margin-top:8px">
      <input id="delUser" class="field" placeholder="Delete username">
      <input id="delPass" class="field" placeholder="Delete password" type="password">
      <div class="confirmRow">
        <button onclick="closeDeleteModal()" class="btn outline">Cancel</button>
        <button id="delConfirmBtn" class="btn primary">Confirm Delete</button>
      </div>
      <div id="delError" style="color:#c62828;display:none"></div>
    </div>
  </div>
</div>

    <!-- Reject Reason Modal -->
    <div id="rejectModal" class="modalBack">
      <div class="modal">
        <h3>Reject Applicant</h3>
        <p class="smallNote">Select a reason for rejection</p>
        <div style="margin-top:8px"> 
          <select id="rejectReasonSelect" class="select">
            <option value="">Select reason</option>
            <option>Out of UC</option>
            <option>Test Fail</option>
            <option>Over Age</option>
            <option>Out of Tehsil & UC</option>
          </select>
        </div>
        <div class="confirmRow" style="margin-top:12px">
          <button onclick="closeRejectModal()" class="btn outline">Cancel</button>
          <button id="confirmRejectBtn" class="btn danger">Confirm Reject</button>
        </div>
      </div>
    </div>

<script>
/*
  Final updated WSSC Recruitment Portal logic (single-file)
  - All requested UI and data behavior implemented
  - Data persisted in localStorage under key STORAGE_KEY
*/

// Constants and keys
// Primary storage key for applicants. Keep legacy key for migration if present.
const STORAGE_KEY = 'wssc_applicants';
const LEGACY_STORAGE_KEY = 'wssc_data_v4';
const COUNTERS_KEY = 'wssc_counters_v4';
const ADMIN_USER = 'admin';
const ADMIN_PASS = 'wssc2025';
const DELETE_USER = 'delete';
const DELETE_PASS = 'delete@wssc2025';

// UC and positions
const UCs = ["Kotla Saidan","Shorkot","Ratta Kulachi","Lachra","Muriali","Other UC"];
const POSITIONS = ["Sanitary Worker","Tractor Driver","Excavator Driver","Dumper Driver","Mechanic","Supervisor"];
const POS_CODE = { "Sanitary Worker":"SW","Tractor Driver":"TD","Excavator Driver":"ED","Dumper Driver":"DD","Mechanic":"ME","Supervisor":"SU" };

// Application state
// Cleanup legacy/test key and sanitize legacy storage before loading applicants (exact requested block)
localStorage.removeItem('wssc_test_data');
let oldData = JSON.parse(localStorage.getItem('wssc_final_v1') || "[]");
if (!Array.isArray(oldData)) oldData = [];
oldData = oldData.filter(a => a && a.name && a.designation && a.name !== "Applicant 1" && a.extra !== "UC2");
localStorage.setItem('wssc_final_v1', JSON.stringify(oldData));
let applicants = JSON.parse(localStorage.getItem('wssc_final_v1') || "[]");

// Initialize main data array from STORAGE_KEY, migrate cleaned applicants if main data is empty
let data = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
if ((!Array.isArray(data) || !data.length) && Array.isArray(applicants) && applicants.length){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(applicants));
  data = applicants.slice();
}
let counters = JSON.parse(localStorage.getItem(COUNTERS_KEY) || '{}'); // per-position counters (recomputed)
let editingId = null;
let pendingDeleteId = null;
// Current status filter from sidebar: 'all' | 'Shortlisted' | 'Selected' | 'Rejected'
let currentStatusFilter = 'all';

// Helpers to ensure every record has createdAt for consistent ordering
function ensureCreatedAtForAll(){
  let changed = false;
  for (let i=0;i<data.length;i++){
    if (!data[i].createdAt){
      const now = new Date().toISOString();
      data[i].createdAt = now;
      changed = true;
    }
  }
  if (changed) persistData();
}

// Ensure every record has a status field (default: Pending)
function ensureStatusForAll(){
  let changed = false;
  for (let i=0;i<data.length;i++){
    if (!('status' in data[i]) || !data[i].status){
      data[i].status = 'Pending';
      changed = true;
    }
  }
  if (changed) persistData();
}

// Rebuild counters, S.No per UC and app numbers per position
function rebuildAllSequences(){
  // Get complete list of UCs including DI KHAN and any UCs in data
  const ucList = [...new Set([...data.map(d => d.uc), ...UCs, 'DI KHAN'])];
  
  // Rebuild S.No per UC
  for (const uc of ucList){
    // Get all records for this UC and sort by creation date
    const rows = data
      .filter(r => r.uc === uc)
      .sort((a,b) => {
        const dateCompare = (a.createdAt||'').localeCompare(b.createdAt||'');
        if (dateCompare !== 0) return dateCompare;
        // If same date, maintain existing order by current S.No
        return (a.sNo || 0) - (b.sNo || 0);
      });
      
    // Assign sequential S.No starting from 1 for each UC
    for (let i = 0; i < rows.length; i++){
      const newSNo = i + 1; // Start from 1
      const idx = data.findIndex(d => d.id === rows[i].id);
      if (idx !== -1) data[idx].sNo = newSNo;
    }
  }
  // Rebuild Application No per Position
  POSITIONS.forEach(pos => rebuildAppNosForPosition(pos));
  // update counters object
  POSITIONS.forEach(p => counters[p] = data.filter(d => d.position === p).length);
  persistCounters();
  persistData();
}

// Rebuild app numbers for a single position ensuring sequential numbering from 1
function rebuildAppNosForPosition(position){
  // Sort by creation date and then by existing app number as secondary sort
  const rows = data.filter(r => r.position === position).sort((a,b) => {
    const dateCompare = (a.createdAt||'').localeCompare(b.createdAt||'');
    if (dateCompare !== 0) return dateCompare;
    
    // If same date, sort by existing app number if available
    const aNum = parseInt((a.appNo || '').split('-')[1]) || 0;
    const bNum = parseInt((b.appNo || '').split('-')[1]) || 0;
    return aNum - bNum;
  });

  // Reassign numbers starting from 1
  for (let i=0; i<rows.length; i++){
    const newAppNo = `${POS_CODE[position]}-${i+1}`; // Start from 1, not 0
    const idx = data.findIndex(d => d.id === rows[i].id);
    if (idx !== -1){
      data[idx].appNo = newAppNo;
    }
  }

  // Update counter to match actual count
  counters[position] = rows.length;
  
  // Ensure persistence
  persistCounters();
  persistData();
}

// Persist helpers
function persistData(){ saveToLocalStorage(); }
function persistCounters(){ localStorage.setItem(COUNTERS_KEY, JSON.stringify(counters)); }

// Initialize sequences from storage
function initSequencesFromStorage(){
  ensureCreatedAtForAll();
  ensureStatusForAll();
  rebuildAllSequences();
}

// Ensure dashboard counts show correct numbers after sequences rebuilt
function initSequencesAndUI(){
  initSequencesFromStorage();
  renderDashboardCounts();
}

// SweetAlert2 small toast helpers (global) - used by multiple places
function showFilterAppliedToast(){
  if (window.Swal){
    Swal.fire({toast:true, position:'top-end', icon:'info', title:'Filter Applied', text:'Showing filtered results by selected UC and Designation.', showConfirmButton:false, timer:2000, timerProgressBar:true});
  }
}
function showAllLoadedToast(){
  if (window.Swal){
    Swal.fire({toast:true, position:'top-end', icon:'success', title:'All Applicants Loaded', text:'Showing all applicants.', showConfirmButton:false, timer:1500, timerProgressBar:true});
  }
}

// Generic toast helper replacing alert()
function showToast(type, title, text, timer=1800){
  if (window.Swal){
    Swal.fire({toast:true, position:'top-end', icon:type, title:title || '', text:text || '', showConfirmButton:false, timer:timer, timerProgressBar:true});
    return;
  }
  // Fallback
  console.log(type, title, text);
}

// ---------- LOGIN ----------
const loginScreen = document.getElementById('loginScreen');
const appDiv = document.getElementById('app');
document.getElementById('loginBtn').addEventListener('click', tryLogin);
document.getElementById('loginUser').addEventListener('keydown', e => { if (e.key==='Enter') tryLogin(); });
document.getElementById('loginPass').addEventListener('keydown', e => { if (e.key==='Enter') tryLogin(); });

function tryLogin(){
  const u = document.getElementById('loginUser').value.trim();
  const p = document.getElementById('loginPass').value;
  const err = document.getElementById('loginError');
  if (u === ADMIN_USER && p === ADMIN_PASS){
    // persist login state so refresh keeps user signed in
    try{ localStorage.setItem('loggedIn','true'); }catch(e){}
    loginScreen.style.display = 'none';
    appDiv.style.display = 'block';
    // Welcome popup using SweetAlert2 (if available) - show and auto-close, then initialize app
    if (window.Swal){
      Swal.fire({
        icon: 'success',
        title: 'Welcome!',
        text: 'You have successfully logged into the WSSC Recruitment Dashboard.',
        showConfirmButton: false,
        timer: 2000
      });
      // initialize app immediately (popup auto-closes)
      initApp();
    } else {
      initApp();
    }
  } else {
    err.textContent = 'Invalid username or password';
    err.style.display = 'block';
    setTimeout(()=>err.style.display='none',2200);
  }
}

// ---------- INIT APP UI ----------
function initApp(){
  // Prepare sequences and counters from storage
  initSequencesAndUI();

  // populate selects and grids
  const dashUc = document.getElementById('dashUc');
  const dashPos = document.getElementById('dashPos');
  const viewUc = document.getElementById('viewUc');
  const viewPos = document.getElementById('viewPos');
  const fUC = document.getElementById('fUC');
  const fUC_fixed = document.getElementById('fUC_fixed');
  const fPosition = document.getElementById('fPosition');
  const fEdu = document.getElementById('fEdu');
  const fEdu_manual = document.getElementById('fEdu_manual');

  [dashUc, viewUc].forEach(s => {
    s.innerHTML = '<option>All</option>';
    UCs.forEach(u => s.innerHTML += `<option>${u}</option>`);
    // also include DI KHAN (tehsil) in view filter
    s.innerHTML += `<option>DI KHAN</option>`;
  });
  [dashPos, viewPos, fPosition].forEach(s => {
    s.innerHTML = '<option>All</option>';
    POSITIONS.forEach(p => s.innerHTML += `<option>${p}</option>`);
  });

  // Fill add form selects
  populateUCSelectAll(); // fills default fUC; will be modified on position change
  fUC_fixed.style.display = 'none';
  fUC_fixed.value = 'DI KHAN';
  fPosition.innerHTML = '<option value="">Select Position</option>';
  POSITIONS.forEach(p => fPosition.innerHTML += `<option>${p}</option>`);
  fEdu.innerHTML = '<option value="">Select Education</option>';
  ["Nil","Matric","F.A / F.Sc","Bachelors (14 Years)","Masters (16 Years)"].forEach(e => fEdu.innerHTML += `<option value="${e}">${e}</option>`);
  fEdu_manual.style.display = 'none';

  // Age dropdown 18-60
  const fAge = document.getElementById('fAge');
  fAge.innerHTML = '<option value="">Select Age</option>';
  for (let a=18; a<=60; a++) fAge.innerHTML += `<option value="${a}">${a}</option>`;

  // Experience dropdown 1-40
  const fExp = document.getElementById('fExp');
  fExp.innerHTML = '<option value="">Select Experience</option>';
  for (let y=1; y<=40; y++) fExp.innerHTML += `<option value="${y}">${y} years</option>`;

  // set today's date in form
  document.getElementById('fDate').value = new Date().toLocaleDateString();

  // nav wiring
  document.querySelectorAll('.navItem').forEach(n => n.addEventListener('click', ()=>{
    document.querySelectorAll('.navItem').forEach(x=>x.classList.remove('active'));
    n.classList.add('active');
  }));

  // sidebar status buttons
  document.querySelectorAll('.statusBtn').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      document.querySelectorAll('.statusBtn').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      const f = btn.getAttribute('data-filter') || 'all';
      currentStatusFilter = f === 'all' ? 'all' : f; // keep exact string for status values
  // keep existing UC/Position filters and re-render with heading
  // If 'all' clicked, clear view filters
  if (currentStatusFilter === 'all'){
    document.getElementById('viewUc').value = 'All';
    document.getElementById('viewPos').value = 'All';
    document.getElementById('searchInput').value = '';
    showPanel('view');
    renderApplicants('all');
    showAllLoadedToast();
  } else {
    showPanel('view');
    renderApplicants(currentStatusFilter);
    showFilterAppliedToast();
  }
    });
    // hover effect
    btn.addEventListener('mouseenter', ()=> btn.style.background = '#f6fbff');
    btn.addEventListener('mouseleave', ()=> { if(!btn.classList.contains('active')) btn.style.background=''; });
  });

  document.getElementById('dashApply').addEventListener('click', ()=>{
    const uc = document.getElementById('dashUc').value;
    const pos = document.getElementById('dashPos').value;
    ensureSelectOption('viewUc', uc);
    ensureSelectOption('viewPos', pos);
  document.getElementById('viewUc').value = uc;
  document.getElementById('viewPos').value = pos;
  // reset status filter and highlight All
  currentStatusFilter = 'all';
  document.querySelectorAll('.statusBtn').forEach(b=>b.classList.remove('active'));
  document.querySelector('.statusBtn[data-filter="all"]').classList.add('active');
  showPanel('view'); renderApplicants('all');
  // show toast indicating filters applied (or All loaded)
  if ((uc === 'All' || !uc) && (pos === 'All' || !pos)) showAllLoadedToast(); else showFilterAppliedToast();
  });
  document.getElementById('dashClear').addEventListener('click', ()=>{ document.getElementById('dashUc').value='All'; document.getElementById('dashPos').value='All'; renderDashboard(); });

  // top buttons
  document.getElementById('logoutBtn').addEventListener('click', ()=>{ localStorage.removeItem('loggedIn'); location.reload(); });
  document.getElementById('exportBtn').addEventListener('click', exportAll);
  document.getElementById('printBtn').addEventListener('click', ()=>window.print());

  // Export panel utilities
  document.getElementById('exportAllBtn').addEventListener('click', exportAll);
  document.getElementById('backupBtn').addEventListener('click', backupAll);
  document.getElementById('restoreBtn').addEventListener('click', ()=> document.getElementById('restoreInput').click());
  document.getElementById('restoreInput').addEventListener('change', (e)=> restoreFromFile(e.target.files[0]));
  document.getElementById('exportPdfBtn').addEventListener('click', exportFilteredPDF);

  // form events
  fPosition.addEventListener('change', onPositionChange);
  document.getElementById('saveBtn').addEventListener('click', onSave);
  document.getElementById('cancelBtn').addEventListener('click', ()=>{ clearForm(); showPanel('dashboard'); });

  // UI toggles: dark mode and sidebar
  const darkToggle = document.getElementById('darkModeToggle');
  const sidebarToggle = document.getElementById('sidebarToggle');
  // Initialize based on localStorage
  if (localStorage.getItem('wssc_dark') === 'true') document.body.classList.add('dark');
  darkToggle.addEventListener('click', ()=>{
    const isDark = document.body.classList.toggle('dark');
    localStorage.setItem('wssc_dark', isDark ? 'true' : 'false');
  });
  sidebarToggle.addEventListener('click', ()=>{
    const sb = document.querySelector('.sidebar');
    sb.classList.toggle('collapsed');
    document.querySelector('.container').classList.toggle('sidebar-collapsed');
  });

  // Enhanced live formatting for CNIC & Contact while typing
  const cnicInput = document.getElementById('fCnic');
  const contactInput = document.getElementById('fContact');
  
  // CNIC input handling
  cnicInput.addEventListener('input', (e) => {
    handleFormattedInput(e.target, formatCNICInput);
  });
  cnicInput.addEventListener('keydown', (e) => {
    // Allow backspace to work naturally
    if (e.key === 'Backspace' && e.target.selectionStart === e.target.selectionEnd) {
      const pos = e.target.selectionStart;
      if (pos === 6 || pos === 14) { // Position after a hyphen
        e.target.setSelectionRange(pos - 1, pos - 1);
      }
    }
  });

  // Contact input handling
  contactInput.addEventListener('input', (e) => {
    handleFormattedInput(e.target, formatContactInput);
  });
  contactInput.addEventListener('keydown', (e) => {
    // Allow backspace to work naturally
    if (e.key === 'Backspace' && e.target.selectionStart === e.target.selectionEnd) {
      const pos = e.target.selectionStart;
      if (pos === 5) { // Position after the hyphen
        e.target.setSelectionRange(pos - 1, pos - 1);
      }
    }
  });

  // Set placeholders
  cnicInput.placeholder = "12345-1234567-1";
  contactInput.placeholder = "0345-1234567";

  // view events
  // view events: use unified handler so filters are reactive and show toast feedback
  function debounce(fn, wait){ let t; return function(){ const args=arguments; clearTimeout(t); t=setTimeout(()=>fn.apply(this,args), wait); }; }
  function showFilterAppliedToast(){ if (window.Swal){ Swal.fire({ toast:true, position:'top-end', icon:'info', title:'Filter Applied', text:'Showing filtered results by selected UC and Designation.', showConfirmButton:false, timer:2000, timerProgressBar:true }); } }
  function showAllLoadedToast(){ if (window.Swal){ Swal.fire({ toast:true, position:'top-end', icon:'success', title:'All Applicants Loaded', text:'Showing all applicants.', showConfirmButton:false, timer:1500, timerProgressBar:true }); } }
  function applyViewFilters(showToast=true){
    // keep currentStatusFilter (set by sidebar). Render respecting that status filter.
    renderApplicants(currentStatusFilter);
    if (showToast){
      const uc = document.getElementById('viewUc')?.value || 'All';
      const pos = document.getElementById('viewPos')?.value || 'All';
      const q = (document.getElementById('searchInput')?.value || '').trim();
      if (uc === 'All' && pos === 'All' && !q && currentStatusFilter === 'all') showAllLoadedToast();
      else showFilterAppliedToast();
    }
  }
  document.getElementById('viewUc').addEventListener('change', ()=> applyViewFilters(true));
  document.getElementById('viewPos').addEventListener('change', ()=> applyViewFilters(true));
  document.getElementById('searchInput').addEventListener('input', debounce(()=> applyViewFilters(true), 300));
  document.getElementById('exportFilteredBtn').addEventListener('click', exportFiltered);
  document.getElementById('printFilteredBtn').addEventListener('click', ()=> window.print());

  // modal delete auth
  document.getElementById('delConfirmBtn').addEventListener('click', confirmDeleteAuth);
  document.getElementById('delUser').addEventListener('keydown', e=>{ if (e.key==='Enter') confirmDeleteAuth(); });
  document.getElementById('delPass').addEventListener('keydown', e=>{ if (e.key==='Enter') confirmDeleteAuth(); });

  // initial render
  renderDashboard();
  renderTable();
}

// Backup all applicant data as JSON file download
function backupAll(){
  const payload = {
    exportedAt: new Date().toISOString(),
    applicants: data
  };
  const blob = new Blob([JSON.stringify(payload, null, 2)], {type: 'application/json'});
  const fname = `wssc_backup_${new Date().toISOString().slice(0,10)}.json`;
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = fname; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  showToast('success','Backup','Backup downloaded');
}

// Restore data from a JSON file (simple validation)
function restoreFromFile(file){
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(ev){
    try{
      const obj = JSON.parse(ev.target.result);
      if (!obj || !Array.isArray(obj.applicants)){ showToast('error','Invalid file','File does not contain applicants array'); return; }
      // Replace current data after confirmation
      Swal.fire({title:'Restore data', text:'This will replace current applicant data. Continue?', icon:'warning', showCancelButton:true, confirmButtonText:'Restore', cancelButtonText:'Cancel'})
        .then(res => {
          if (!res.isConfirmed) return;
          data = obj.applicants;
          saveToLocalStorage();
          rebuildAllSequences();
          renderDashboard();
          renderTable();
          updateCharts();
          showToast('success','Restored','Data restored from backup');
        });
    }catch(e){ showToast('error','Invalid file','Could not parse JSON'); }
  };
  reader.readAsText(file);
}

// Export the current filtered view to PDF using jsPDF
function exportFilteredPDF(){
  const rows = getFilteredRows();
  if (!rows.length){ showToast('info','No data','No data for selected filter'); return; }
  // Use jsPDF
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({unit:'pt', format:'a4'});
  const margin = 40; let y = 60;
  // Header with optional logo (if LOGO.PNG present in same folder, it will try to load)
  const title = 'WSSC D.I. Khan - Applicants Report';
  doc.setFontSize(14);
  doc.text(title, margin, y);
  y += 18;
  doc.setFontSize(10);
  doc.text(`Generated: ${new Date().toLocaleString()}`, margin, y);
  y += 18;

  // Table header
  const cols = ["S.No","App No","Name","Father","Age","CNIC","UC","Extra","Contact","Exp","Education","Address","Date","Status"];
  const colWidths = [30,60,80,80,30,70,60,50,70,40,70,120,50,60];
  doc.setFontSize(9);
  // Render rows with simple pagination
  const pageHeight = doc.internal.pageSize.height;
  const rowHeight = 16;
  // draw header
  let x = margin;
  cols.forEach((c,i)=>{ doc.text(c, x + 2, y); x += colWidths[i]; });
  y += rowHeight;
  for (let i=0;i<rows.length;i++){
    const r = rows[i];
    x = margin;
    const values = [ (i+1).toString(), r.appNo||'', r.name||'', r.father||'', r.age||'', formatCNICStored(r.cnic||''), r.uc||'', r.extra||'', formatContactStored(r.contact||''), (r.experience||0).toString(), r.education||'', (r.address||'').substring(0,80), r.date||'', r.status||'Pending' ];
    for (let j=0;j<values.length;j++){
      const text = String(values[j]);
      doc.text(text, x + 2, y);
      x += colWidths[j];
    }
    y += rowHeight;
    if (y + rowHeight > pageHeight - margin){ doc.addPage(); y = margin; }
  }
  const fname = `Applications_Filtered_${new Date().toISOString().slice(0,10)}.pdf`;
  doc.save(fname);
  showToast('success','Exported','PDF generated: ' + fname, 2200);
}

// show panel helper
function showPanel(name){
  // hide all panels then fade in the requested one
  ['panel-dashboard','panel-add','panel-view','panel-export'].forEach(id=>{
    const el = document.getElementById(id);
    if (!el) return;
    el.classList.add('hide');
    el.classList.remove('fade-in');
  });
  document.getElementById('navDashboard').classList.remove('active');
  document.getElementById('navAdd').classList.remove('active');
  document.getElementById('navView').classList.remove('active');
  document.getElementById('navExport').classList.remove('active');
  const target = document.getElementById('panel-' + name);
  if (target){
    target.classList.remove('hide');
    // small delay for removing then adding animation class
    setTimeout(()=> target.classList.add('fade-in'), 8);
  }
  if (name==='dashboard') document.getElementById('navDashboard').classList.add('active');
  if (name==='add') document.getElementById('navAdd').classList.add('active');
  if (name==='view') document.getElementById('navView').classList.add('active');
  if (name==='export') document.getElementById('navExport').classList.add('active');
}

// ---------- Dashboard ----------
function renderDashboard(){
  renderDashboardCounts();

  // UC grid
  const ucGrid = document.getElementById('ucGrid'); ucGrid.innerHTML = '';
  // Show DI KHAN as a box too (count all records whose uc == 'DI KHAN')
  const allUCs = ['DI KHAN', ...UCs];
  allUCs.forEach(uc=>{
    const cnt = data.filter(d=>d.uc===uc).length;
    const box = document.createElement('div'); box.className='box';
    box.innerHTML = `<h4>${uc}</h4><p>${cnt} Applicants</p>`;
    box.onclick = ()=>{ 
      document.getElementById('dashUc').value = uc; 
      ensureSelectOption('viewUc', uc); 
      document.getElementById('viewUc').value = uc; 
      // reset status filter to show all in this UC view
      currentStatusFilter = 'all';
      document.querySelectorAll('.statusBtn').forEach(b=>b.classList.remove('active'));
      document.querySelector('.statusBtn[data-filter="all"]').classList.add('active');
      showPanel('view'); 
      // render with heading and current filters
      renderApplicants('all');
    };
    ucGrid.appendChild(box);
  });

  // pos grid
  const posGrid = document.getElementById('posGrid'); posGrid.innerHTML = '';
  POSITIONS.forEach(pos=>{
    const cnt = data.filter(d=>d.position===pos).length;
    const box = document.createElement('div'); box.className='box'; box.style.minWidth='140px';
    box.innerHTML = `<h4>${pos}</h4><p>${cnt}</p>`;
    box.onclick = ()=>{ 
      document.getElementById('dashPos').value = pos; 
      ensureSelectOption('viewPos', pos); 
      document.getElementById('viewPos').value = pos; 
      // reset status filter to show all in this Position view
      currentStatusFilter = 'all';
      document.querySelectorAll('.statusBtn').forEach(b=>b.classList.remove('active'));
      document.querySelector('.statusBtn[data-filter="all"]').classList.add('active');
      showPanel('view'); 
      renderApplicants('all');
    };
    posGrid.appendChild(box);
  });
}

// Ensure that a select element contains an option with the given value (adds it if missing)
function ensureSelectOption(selectId, value){
  const sel = document.getElementById(selectId);
  if (!sel) return;
  let found = false;
  for (let i=0;i<sel.options.length;i++){ if (sel.options[i].value === value || sel.options[i].text === value) { found = true; break; } }
  if (!found){ const opt = document.createElement('option'); opt.text = value; opt.value = value; sel.add(opt); }
}

// ---------- UC & Position conditional UI ----------
// populate full UC select
function populateUCSelectAll(){
  const fUC = document.getElementById('fUC');
  fUC.innerHTML = '<option value="">Select UC</option>';
  UCs.forEach(u => fUC.innerHTML += `<option>${u}</option>`);
  // user may select DI KHAN only when allowed via fixed input
}

// populate UC select for specific position rules
function populateUCSelectForPosition(position){
  const fUC = document.getElementById('fUC');
  const fUC_fixed = document.getElementById('fUC_fixed');
  const ucLabel = document.getElementById('ucLabel');

  // default: show select with all UCs and label 'UC'
  ucLabel.innerText = 'UC';
  fUC.style.display = 'inline-block';
  fUC_fixed.style.display = 'none';

  if (["Dumper Driver","Excavator Driver","Mechanic"].includes(position)){
    // fixed tehsil
    ucLabel.innerText = 'Tehsil';
    fUC.style.display = 'none';
    fUC_fixed.style.display = 'inline-block';
    fUC_fixed.value = 'DI KHAN';
    return;
  }

  if (position === 'Supervisor'){
    // supervisors only Kotla Saidan, Lachra, Other UC
    ucLabel.innerText = 'UC';
    const opts = ["Kotla Saidan","Lachra","Other UC"];
    fUC.innerHTML = '<option value="">Select UC</option>';
    opts.forEach(o => fUC.innerHTML += `<option>${o}</option>`);
    fUC_fixed.style.display = 'none';
    return;
  }

  if (position === 'Tractor Driver'){
    // same as default but remove Shorkot
    ucLabel.innerText = 'UC';
    const opts = UCs.filter(u => u !== 'Shorkot');
    fUC.innerHTML = '<option value="">Select UC</option>';
    opts.forEach(o => fUC.innerHTML += `<option>${o}</option>`);
    fUC_fixed.style.display = 'none';
    return;
  }

  // Sanitary Worker and others: all UCs
  ucLabel.innerText = 'UC';
  populateUCSelectAll();
  fUC_fixed.style.display = 'none';
}

// adjust education field display for position
function setEducationFieldForPosition(position){
  const fEdu = document.getElementById('fEdu');
  const fEdu_manual = document.getElementById('fEdu_manual');
  const mechanicWrap = document.getElementById('mechanicDiplomaWrap');
  const eduLabel = document.getElementById('eduLabel');

  // defaults
  fEdu.style.display = 'inline-block';
  fEdu_manual.style.display = 'none';
  mechanicWrap.style.display = 'none';
  eduLabel.innerText = 'Education';

  if (position === 'Supervisor'){
    fEdu.style.display = 'none';
    fEdu_manual.style.display = 'inline-block';
    mechanicWrap.style.display = 'none';
    eduLabel.innerText = 'Education';
  } else if (position === 'Mechanic'){
    // Show Diploma dropdown plus specialty input
    fEdu.style.display = 'none';
    fEdu_manual.style.display = 'none';
    mechanicWrap.style.display = 'block';
    eduLabel.innerText = 'Education';
  } else {
    // normal dropdown
    fEdu.style.display = 'inline-block';
    fEdu_manual.style.display = 'none';
    mechanicWrap.style.display = 'none';
    eduLabel.innerText = 'Education';
  }
}

// called when position select changes
function onPositionChange(e){
  const pos = e.target.value;
  const extraDiv = document.getElementById('fExtra');
  extraDiv.innerHTML = '';
  if (!pos) {
    document.getElementById('fAppNo').value = '';
    populateUCSelectAll();
    setEducationFieldForPosition('');
    return;
  }

  // UC control and label
  populateUCSelectForPosition(pos);

  // Education control for supervisor / mechanic
  setEducationFieldForPosition(pos);

  // Get next available application number for the selected designation
  const existingAppNos = data
    .filter(d => d.position === pos)
    .map(d => parseInt((d.appNo || '').split('-')[1]) || 0)
    .sort((a, b) => a - b);
  
  // Find first available number starting from 1
  let nextNumber = 1;
  if (existingAppNos.length > 0) {
    // Check for gaps in sequence
    for (let i = 0; i < existingAppNos.length; i++) {
      if (existingAppNos[i] !== i + 1) {
        nextNumber = i + 1;
        break;
      }
      nextNumber = existingAppNos.length + 1;
    }
  }
  
  document.getElementById('fAppNo').value = `${POS_CODE[pos]}-${nextNumber}`;

  // extra fields per position (unchanged from previous logic)
  if (pos === 'Sanitary Worker'){
    extraDiv.innerHTML = `<div class="label">Physically Fit</div><div class="field"><select id="fPhys"><option>Yes</option><option>No</option></select></div>`;
  } else if (pos === 'Mechanic'){
    // mechanic also gets diploma UI handled separately
    extraDiv.innerHTML = `<div class="label">Diploma / Specialty</div><div class="smallNote">Choose diploma years and enter specialty below.</div>`;
  } else if (['Tractor Driver','Excavator Driver','Dumper Driver'].includes(pos)){
    extraDiv.innerHTML = `<div class="label">License Type</div><div class="field"><select id="fLicense"><option>LTV</option><option>HTV</option><option>Learner</option></select></div>`;
  }
}

// clear form
function clearForm(){
  editingId = null;
  document.getElementById('appForm').reset();
  document.getElementById('fExtra').innerHTML = '';
  document.getElementById('fDate').value = new Date().toLocaleDateString();
  document.getElementById('formMsg').style.display = 'none';
  // ensure default UC and EDU displays
  populateUCSelectAll();
  document.getElementById('fUC_fixed').style.display = 'none';
  document.getElementById('fEdu_manual').style.display = 'none';
  document.getElementById('fEdu').style.display = 'inline-block';
  document.getElementById('mechanicDiplomaWrap').style.display = 'none';
  document.getElementById('ucLabel').innerText = 'UC';
}

// ---------- live formatters (typing) ----------
function formatCNICInput(v, cursorPosition = 0) {
  // Remove all non-digits and limit to 13 digits
  const digits = v.replace(/\D/g, '').slice(0, 13);
  let formatted = digits;
  let offset = 0;
  
  // Apply formatting based on length
  if (digits.length > 5) {
    formatted = digits.slice(0, 5) + '-' + digits.slice(5);
    if (cursorPosition > 5) offset++;
  }
  if (digits.length > 12) {
    formatted = formatted.slice(0, 13) + '-' + formatted.slice(13);
    if (cursorPosition > 12) offset++;
  }
  
  // Calculate new cursor position
  const newPosition = Math.min(cursorPosition + offset, formatted.length);
  
  return {
    text: formatted,
    position: newPosition
  };
}

function formatContactInput(v, cursorPosition = 0) {
  // Remove non-digits and limit to 11 digits
  const digits = v.replace(/\D/g, '').slice(0, 11);
  let formatted = digits;
  let offset = 0;
  
  // Apply formatting
  if (digits.length > 4) {
    formatted = digits.slice(0, 4) + '-' + digits.slice(4);
    if (cursorPosition > 4) offset++;
  }
  
  // Calculate new cursor position
  const newPosition = Math.min(cursorPosition + offset, formatted.length);
  
  return {
    text: formatted,
    position: newPosition
  };
}

function formatCNICStored(v) {
  if (!v) return '';
  const d = v.toString().replace(/\D/g, '');
  if (d.length === 13) return `${d.slice(0, 5)}-${d.slice(5, 12)}-${d.slice(12)}`;
  return v;
}

function formatContactStored(v) {
  if (!v) return '';
  const d = v.toString().replace(/\D/g, '');
  if (d.length === 11) return `${d.slice(0, 4)}-${d.slice(4)}`;
  return v;
}

// Enhanced input handlers
function handleFormattedInput(input, formatter) {
  const start = input.selectionStart;
  const result = formatter(input.value, start);
  
  // Only update if the formatted text is different
  if (input.value !== result.text) {
    input.value = result.text;
    // Restore cursor position
    input.setSelectionRange(result.position, result.position);
  }
}

  // save (add or update)
function onSave(){
  const pos = document.getElementById('fPosition').value;
  // UC can be in select or fixed input
  const fUC_el = document.getElementById('fUC');
  const fUC_fixed_el = document.getElementById('fUC_fixed');
  const uc = (fUC_fixed_el.style.display !== 'none' && fUC_fixed_el.value) ? fUC_fixed_el.value : fUC_el.value;
  const appNoField = document.getElementById('fAppNo').value || '';
  const name = document.getElementById('fName').value.trim();
  const father = document.getElementById('fFather').value.trim();
  const cnicRaw = document.getElementById('fCnic').value.trim();
  const contactRaw = document.getElementById('fContact').value.trim();
  const cnic = formatCNICStored(cnicRaw);
  const contact = formatContactStored(contactRaw);
  // age and exp are selects
  const age = document.getElementById('fAge').value;
  const expRaw = document.getElementById('fExp').value;
  const exp = expRaw ? Number(expRaw) : 0;
  // education handling depends on position
  let edu = '';
  if (pos === 'Supervisor'){
    edu = document.getElementById('fEdu_manual').value.trim();
  } else if (pos === 'Mechanic'){
    const dy = document.getElementById('fDiplomaYears').value;
    const sp = document.getElementById('fDiplomaSpec').value.trim();
    if (!dy){
      showFormMessage('Please select Diploma years for Mechanic.');
      return;
    }
    // combine into education text
    edu = `${dy}${sp ? ' - ' + sp : ''}`;
  } else {
    edu = document.getElementById('fEdu').value;
  }

  const addr = document.getElementById('fAddr').value;
  const date = document.getElementById('fDate').value || new Date().toLocaleDateString();
  const remarks = document.getElementById('fRemarks').value || '';
  const extra = document.getElementById('fPhys')?.value || document.getElementById('fLicense')?.value || document.getElementById('fDiploma')?.value || '';

  // Enhanced validation for blank fields
  if (!pos || !uc || !name || !father || !cnic || cnic.replace(/\D/g,'').length !== 13){
    showFormMessage('Please fill all required fields correctly (Designation, UC/Tehsil, Name, Father, valid CNIC)');
    return;
  }
  
  // Remove any whitespace in CNIC before comparison
  const cleanCNIC = cnic.replace(/\D/g,'');  // Enhanced duplicate CNIC check (exclude editing)
  const dup = data.find(d => {
    if (d.id === editingId) return false; // Skip current record if editing
    const existingCNIC = d.cnic?.replace(/\D/g,'');
    return existingCNIC && existingCNIC === cleanCNIC;
  });
  
  if (dup){
    showFormMessage('Duplicate CNIC detected â€” record already exists.');
    return;
  }

  if (editingId){
    // update existing record
    const idx = data.findIndex(d => d.id === editingId);
    if (idx === -1) { showFormMessage('Record not found for update'); return; }
    const oldPosition = data[idx].position;
    const oldUc = data[idx].uc;
    
    // Update with status preservation
    const oldStatus = data[idx].status || 'Pending';
    const oldRejectReason = data[idx].rejectReason;
    
    data[idx] = { 
      ...data[idx], 
      position: pos, 
      uc, 
      name, 
      father, 
      cnic, 
      contact, 
      age, 
      experience: exp, 
      education: edu, 
      address: addr, 
      date, 
      extra, 
      remarks,
      status: oldStatus,
      rejectReason: oldRejectReason
    };
    
    // If position changed -> rebuild appNos for both old and new positions
    if (pos !== oldPosition){
      rebuildAppNosForPosition(oldPosition);
      rebuildAppNosForPosition(pos);
    } else {
      rebuildAppNosForPosition(pos);
    }
    // rebuild S.No for UCs (in case UC changed)
    rebuildAllSequences();
    renderDashboard();
    renderTable();
    clearForm();
  showToast('success','Updated','Updated successfully');
    showPanel('dashboard');
  } else {
    // add new record with proper initialization
    const rec = {
      id: generateId(),
      position: pos,
      uc,
      name,
      father,
      cnic,
      contact,
      age,
      experience: exp,
      education: edu,
      address: addr,
      date,
      extra,
      remarks,
      status: status, // Use selected status from form
      createdAt: new Date().toISOString()
    };
    // Add the record and ensure proper data persistence
    data.push(rec);
    
    // Rebuild sequences and save to storage
    rebuildAllSequences();
    saveToLocalStorage();
    
    // Update all views
    renderDashboardCounts();
    renderTable();
    clearForm();
    
    // Show success message and return to dashboard
    if (window.Swal) {
      Swal.fire({
        icon: 'success',
        title: 'Success',
        text: 'Applicant record saved successfully.',
        timer: 2000,
        showConfirmButton: false
      });
    } else {
    showToast('success','Saved','Applicant record saved successfully');
    }
    showPanel('dashboard');
  }
}

// show message in form
function showFormMessage(msg){
  const el = document.getElementById('formMsg');
  el.textContent = msg; el.style.display = 'block';
  setTimeout(()=> el.style.display = 'none', 4000);
}

// ---------- Core helper functions (new modular API) ----------
async function saveToLocalStorage(){ 
  // Remove any potential duplicate records by CNIC
  const uniqueData = [];
  const seenCNICs = new Set();
  
  for (const record of data) {
    const cleanCNIC = record.cnic?.replace(/\D/g,'');
    if (cleanCNIC && !seenCNICs.has(cleanCNIC)) {
      seenCNICs.add(cleanCNIC);
      uniqueData.push(record);
    }
  }
  
  // Update data array with deduplicated records
  data = uniqueData;
  
  // Save to localStorage
  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  
  // Save to Firebase
  try {
    await saveToFirebase();
  } catch (error) {
    console.error('Error saving to Firebase:', error);
    // Show error using SweetAlert2
    if (window.Swal) {
      Swal.fire({
        icon: 'error',
        title: 'Sync Error',
        text: 'Could not sync changes to database'
      });
    }
  }
  
  // Update insights when data changes
  updateInsights();
}

// New alias to match requested API
function saveApplicants(){
  // central save function
  saveToLocalStorage();
}

// Update applicant status by id and persist. newStatus: Pending|Shortlisted|Selected|Rejected
function updateApplicantStatus(applicantId, newStatus, rejectReason=''){
  // find record and update
  const idx = data.findIndex(d=>d.id === applicantId);
  if (idx === -1) return;
  // If trying to change a Selected applicant away, prevent unless explicitly allowed
  if (data[idx].status === 'Selected' && newStatus !== 'Selected'){
    // prevent downgrading Selected unless forcing
  showToast('warning','Action blocked','Cannot change status of a Selected applicant');
    return;
  }
  data[idx].status = newStatus;
  if (newStatus === 'Rejected') data[idx].rejectReason = rejectReason || data[idx].rejectReason || '';
  if (newStatus !== 'Rejected') delete data[idx].rejectReason;
  saveApplicants();
  rebuildAllSequences();
  updateDashboardCounts();
  // Keep current view/filter
  renderApplicants(currentStatusFilter);
}

function renderDashboardCounts(){
  // animated counters for totals and status counts
  const totalEl = document.getElementById('totalApplicants');
  const pendingEl = document.getElementById('countPending');
  const shortEl = document.getElementById('countShortlisted');
  const selEl = document.getElementById('countSelected');
  const rejEl = document.getElementById('countRejected');
  const ucEl = document.getElementById('distinctUCs');

  const totals = data.length;
  const pending = data.filter(d=>d.status==='Pending').length;
  const shortlisted = data.filter(d=>d.status==='Shortlisted').length;
  const selected = data.filter(d=>d.status==='Selected').length;
  const rejected = data.filter(d=>d.status==='Rejected').length;
  const distinctUCs = [...new Set(data.map(d=>d.uc))].length || 0;

  // helper animator
  function animate(el, to){
    const from = parseInt(el.textContent) || 0;
    if (from === to) { el.textContent = to; return; }
    const start = performance.now();
    const dur = 700;
    function step(ts){
      const p = Math.min((ts - start) / dur, 1);
      el.textContent = Math.round(from + (to - from) * p);
      if (p < 1) requestAnimationFrame(step);
    }
    requestAnimationFrame(step);
  }

  animate(totalEl, totals);
  animate(pendingEl, pending);
  animate(shortEl, shortlisted);
  animate(selEl, selected);
  animate(rejEl, rejected);
  animate(ucEl, distinctUCs);

  document.getElementById('lastSubmission').textContent = data.length ? data[data.length-1].date : '-';
}

// Alias requested by spec
function updateDashboardCounts(){ 
  renderDashboardCounts();
  updateInsights();
}

// Calculate and update insights section
function updateInsights() {
  if (!data.length) {
    // Set default "no data" state
    document.getElementById('insightTopUC').textContent = '-';
    document.getElementById('insightTopUCCount').textContent = '0 applicants';
    document.getElementById('insightTopQual').textContent = '-';
    document.getElementById('insightTopQualCount').textContent = '0 applicants';
    document.getElementById('insightAvgAge').textContent = '-';
    document.getElementById('insightAgeRange').textContent = 'No data';
    document.getElementById('insightMaxExp').textContent = '-';
    document.getElementById('insightExpPos').textContent = 'No data';
    document.getElementById('insightTrending').textContent = '-';
    document.getElementById('insightTrendingCount').textContent = '0 recent applications';
    return;
  }

  // Most Applied UC
  const ucCounts = {};
  data.forEach(d => {
    ucCounts[d.uc] = (ucCounts[d.uc] || 0) + 1;
  });
  const topUC = Object.entries(ucCounts)
    .sort((a, b) => b[1] - a[1])[0];
  document.getElementById('insightTopUC').textContent = topUC[0];
  document.getElementById('insightTopUCCount').textContent = `${topUC[1]} applicant${topUC[1] !== 1 ? 's' : ''}`;

  // Most Common Qualification
  const qualCounts = {};
  data.forEach(d => {
    if (d.education) {
      qualCounts[d.education] = (qualCounts[d.education] || 0) + 1;
    }
  });
  const topQual = Object.entries(qualCounts)
    .sort((a, b) => b[1] - a[1])[0];
  document.getElementById('insightTopQual').textContent = 
    topQual[0].length > 15 ? topQual[0].substring(0, 12) + '...' : topQual[0];
  document.getElementById('insightTopQualCount').textContent = `${topQual[1]} applicant${topQual[1] !== 1 ? 's' : ''}`;

  // Average Age
  const ages = data.map(d => parseInt(d.age)).filter(age => !isNaN(age));
  const avgAge = ages.reduce((sum, age) => sum + age, 0) / ages.length;
  const minAge = Math.min(...ages);
  const maxAge = Math.max(...ages);
  document.getElementById('insightAvgAge').textContent = Math.round(avgAge);
  document.getElementById('insightAgeRange').textContent = `Range: ${minAge}-${maxAge} years`;

  // Highest Experience
  const maxExpRecord = [...data]
    .sort((a, b) => (parseInt(b.experience) || 0) - (parseInt(a.experience) || 0))[0];
  document.getElementById('insightMaxExp').textContent = `${maxExpRecord.experience} Years`;
  document.getElementById('insightExpPos').textContent = maxExpRecord.position;

  // Trending Designation (last 30 days)
  const thirtyDaysAgo = new Date();
  thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
  const recentApps = data.filter(d => new Date(d.createdAt) > thirtyDaysAgo);
  const posCounts = {};
  recentApps.forEach(d => {
    posCounts[d.position] = (posCounts[d.position] || 0) + 1;
  });
  const trending = Object.entries(posCounts)
    .sort((a, b) => b[1] - a[1])[0];
  if (trending) {
    document.getElementById('insightTrending').textContent = trending[0];
    document.getElementById('insightTrendingCount').textContent = 
      `${trending[1]} recent application${trending[1] !== 1 ? 's' : ''}`;
  }
}

// updateStatus: change status and optional reject reason, persist and re-render
function updateStatus(applicantId, newStatus, rejectReason=''){
  // backward-compatible alias for updateApplicantStatus
  updateApplicantStatus(applicantId, newStatus, rejectReason);
}

// renderApplicants is the modular render method; kept compatible with previous renderTable
function renderApplicants(filterStatus){
  // set heading based on filter
  const heading = document.getElementById('viewHeading');
  const hf = filterStatus || currentStatusFilter || 'all';
  if (hf === 'all') heading.textContent = 'View / Search Applicants (All)';
  else heading.textContent = `View / Search Applicants â€” ${hf}`;
  renderTable(hf);
}

// ---------- Render table (View) ----------
  document.getElementById('viewUc').addEventListener('change', ()=>renderApplicants(currentStatusFilter));
  document.getElementById('viewPos').addEventListener('change', ()=>renderApplicants(currentStatusFilter));
  document.getElementById('searchInput').addEventListener('input', ()=>renderApplicants(currentStatusFilter));

// Helper: compute filtered rows based on UC/Position/Search and optional status
function getFilteredRows(statusFilter){
  const ucFilter = document.getElementById('viewUc')?.value || 'All';
  const pos = document.getElementById('viewPos')?.value || 'All';
  const q = (document.getElementById('searchInput')?.value || '').trim().toLowerCase();
  let rows = data.slice();
  if (ucFilter !== 'All') rows = rows.filter(r=>r.uc === ucFilter);
  if (pos !== 'All') rows = rows.filter(r=>r.position === pos);
  if (q) rows = rows.filter(r => (r.name||'').toLowerCase().includes(q) || (r.cnic||'').toLowerCase().includes(q));
  const sf = statusFilter || currentStatusFilter || 'all';
  if (sf !== 'all') rows = rows.filter(r => r.status === sf);
  rows.sort((a,b) => {
    if (a.uc === b.uc) return (a.sNo||0) - (b.sNo||0);
    return a.uc.localeCompare(b.uc);
  });
  return rows;
}

function renderTable(statusOrRows){
  // if array passed, render directly; else treat as optional status filter
  let rows;
  if (Array.isArray(statusOrRows)) rows = statusOrRows;
  else rows = getFilteredRows(statusOrRows);
  const wrap = document.getElementById('tableContainer');
  if (!rows.length){ wrap.innerHTML = '<p>No applicants found for this filter.</p>'; return; }
  // build table with optimized layout and sticky header
  let html = '<div class="tableWrap"><table><thead><tr>' + 
    '<th>S.No</th>' +
    '<th>App No</th>' +
    '<th>Name</th>' +
    '<th>Father</th>' +
    '<th>Age</th>' +
    '<th>CNIC</th>' +
    '<th>UC/Tehsil</th>' +
    '<th>Extra</th>' +
    '<th>Contact</th>' +
    '<th>Exp</th>' +
    '<th>Education</th>' +
    '<th>Address</th>' +
    '<th>Date</th>' +
    '<th>Status</th>' +
    '<th>Actions</th>' +
    '</tr></thead><tbody>';
  // we'll display S.No as the index in the current view to keep numbering contiguous for the filtered set
  rows.forEach((r, idx) => {
    const currentStatus = r.status || 'Pending';
    const statusClass = `status-${currentStatus.toLowerCase()}`;
    // prepare status control HTML
    let statusControl = `
      <div style="display:flex;flex-direction:column;gap:6px;align-items:center">
        <div class="status-badge ${currentStatus.toLowerCase()}">${currentStatus}</div>
        <select class="status-select" onchange="updateApplicantStatus('${r.id}', this.value)" style="width:100px">
          <option value="Pending" ${currentStatus === 'Pending' ? 'selected' : ''}>Pending</option>
          <option value="Shortlisted" ${currentStatus === 'Shortlisted' ? 'selected' : ''}>Shortlist</option>
          <option value="Selected" ${currentStatus === 'Selected' ? 'selected' : ''}>Select</option>
          <option value="Rejected" ${currentStatus === 'Rejected' ? 'selected' : ''}>Reject</option>
        </select>
        ${currentStatus === 'Rejected' && r.rejectReason ? 
          `<div style="font-size:11px;color:#666">${escapeHtml(r.rejectReason)}</div>` 
          : ''}
      </div>`;

    const rowStatus = r.status || 'Pending';
    html += `<tr class="status-${rowStatus.toLowerCase()}">
  <td>${idx+1}</td>
      <td>${escapeHtml(r.appNo)}</td>
      <td style="text-align:left">${escapeHtml(r.name)}</td>
      <td style="text-align:left">${escapeHtml(r.father)}</td>
      <td>${escapeHtml(r.age)}</td>
      <td>${escapeHtml(formatCNICStored(r.cnic))}</td>
      <td>${escapeHtml(r.uc)}</td>
      <td>${escapeHtml(r.extra)}</td>
      <td>${escapeHtml(formatContactStored(r.contact))}</td>
      <td>${escapeHtml((r.experience||0) + ' yrs')}</td>
      <td>${escapeHtml(r.education)}</td>
      <td style="text-align:left">${escapeHtml(r.address)}</td>
      <td>${escapeHtml(r.date)}</td>
  <td style="min-width:140px">${statusControl}</td>
      <td>
        <div style="display:flex;flex-direction:column;gap:2px;align-items:center">
          <button class="btn outline" onclick="startEdit('${r.id}')">Edit</button>
          <button class="btn danger" onclick="requestDelete('${r.id}')">Delete</button>
        </div>
      </td>
    </tr>`;
  });
  html += '</tbody></table></div>';
  wrap.innerHTML = html;
}

// ---------- Edit ----------
function startEdit(id){
  const rec = data.find(d=>d.id===id);
  if (!rec) { showToast('error','Not found','Record not found'); return; }
  editingId = id;
  showPanel('add');
  document.getElementById('fPosition').value = rec.position;
  // configure UC field per position
  populateUCSelectForPosition(rec.position);
  // set UC value into visible control
  const fUC_fixed = document.getElementById('fUC_fixed');
  const fUC = document.getElementById('fUC');
  if (fUC_fixed.style.display !== 'none'){
    fUC_fixed.value = rec.uc;
  } else {
    fUC.value = rec.uc || '';
  }
  
  // Set status
  document.getElementById('fStatus').value = rec.status || 'Pending';

  document.getElementById('fAppNo').value = rec.appNo;
  document.getElementById('fName').value = rec.name;
  document.getElementById('fFather').value = rec.father;
  document.getElementById('fCnic').value = formatCNICStored(rec.cnic);
  document.getElementById('fContact').value = formatContactStored(rec.contact);
  document.getElementById('fAge').value = rec.age || '';
  document.getElementById('fExp').value = rec.experience || '';

  // education: supervisor manual vs select vs mechanic diploma
  if (rec.position === 'Supervisor'){
    document.getElementById('fEdu').style.display = 'none';
    const fEdu_manual = document.getElementById('fEdu_manual');
    fEdu_manual.style.display = 'inline-block';
    fEdu_manual.value = rec.education || '';
    document.getElementById('mechanicDiplomaWrap').style.display = 'none';
  } else if (rec.position === 'Mechanic'){
    // parse stored education if stored as "2 Years - Auto Mobile"
    const mechWrap = document.getElementById('mechanicDiplomaWrap');
    mechWrap.style.display = 'block';
    document.getElementById('fEdu').style.display = 'none';
    document.getElementById('fEdu_manual').style.display = 'none';
    const parts = (rec.education || '').split(' - ');
    const years = parts[0] || '';
    const spec = parts[1] || '';
    document.getElementById('fDiplomaYears').value = years;
    document.getElementById('fDiplomaSpec').value = spec;
  } else {
    document.getElementById('fEdu').style.display = 'inline-block';
    document.getElementById('fEdu_manual').style.display = 'none';
    document.getElementById('mechanicDiplomaWrap').style.display = 'none';
    document.getElementById('fEdu').value = rec.education || '';
  }

  document.getElementById('fAddr').value = rec.address;
  document.getElementById('fDate').value = rec.date;
  document.getElementById('fRemarks').value = rec.remarks;
  // extra
  const extraDiv = document.getElementById('fExtra');
  extraDiv.innerHTML = '';
  if (rec.position === 'Sanitary Worker') extraDiv.innerHTML = `<div class="label">Physically Fit</div><div class="field"><select id="fPhys"><option>Yes</option><option>No</option></select></div>`;
  if (rec.position === 'Mechanic') extraDiv.innerHTML = `<div class="label">Diploma</div><div class="smallNote">Select diploma years and specialty above.</div>`;
  if (['Tractor Driver','Excavator Driver','Dumper Driver'].includes(rec.position)) extraDiv.innerHTML = `<div class="label">License Type</div><div class="field"><select id="fLicense"><option>LTV</option><option>HTV</option><option>Learner</option></select></div>`;
  setTimeout(()=> {
    if (document.getElementById('fPhys')) document.getElementById('fPhys').value = rec.extra || 'Yes';
    if (document.getElementById('fDiploma')) document.getElementById('fDiploma').value = rec.extra || 'Yes';
    if (document.getElementById('fLicense')) document.getElementById('fLicense').value = rec.extra || 'LTV';
  },60);
}

// ---------- Delete (with auth modal) ----------
function requestDelete(id){
  pendingDeleteId = id;
  document.getElementById('delUser').value = '';
  document.getElementById('delPass').value = '';
  document.getElementById('delError').style.display = 'none';
  document.getElementById('deleteModal').style.display = 'flex';
}
function closeDeleteModal(){ pendingDeleteId = null; document.getElementById('deleteModal').style.display = 'none'; }
function confirmDeleteAuth(){
  const u = document.getElementById('delUser').value.trim();
  const p = document.getElementById('delPass').value;
  const err = document.getElementById('delError');
  if (u !== DELETE_USER || p !== DELETE_PASS){
    err.textContent = 'Invalid delete credentials';
    err.style.display = 'block';
    setTimeout(()=>err.style.display='none',2200);
    return;
  }
  // confirmed: delete record
  if (!pendingDeleteId) { closeDeleteModal(); return; }
  const idx = data.findIndex(d=>d.id===pendingDeleteId);
  if (idx === -1){ showToast('error','Not found','Record not found'); closeDeleteModal(); return; }
  // Show confirmation modal using Swal
  Swal.fire({title:'Confirm delete', text:'Are you sure you want to delete this entry? This action cannot be undone.', icon:'warning', showCancelButton:true, confirmButtonText:'Delete', cancelButtonText:'Cancel'})
    .then(res => {
      if (!res.isConfirmed) return;
      data.splice(idx,1);
      // After delete, rebuild sequences so numbering is continuous
      rebuildAllSequences();
      closeDeleteModal();
      renderDashboard(); // This will update charts
      renderTable();
      // Show success message
      showToast('success','Deleted','Record has been removed successfully');
    });
}

// ---------- Export Excel ----------
function exportAll(){
  if (!data.length){ showToast('info','No data','No data to export'); return; }
  const wb = XLSX.utils.book_new();
  // Include DI KHAN as UC grouping as well
  const ucsToExport = ['DI KHAN', ...UCs];
  ucsToExport.forEach(uc=>{
    POSITIONS.forEach(pos=>{
      const rows = data.filter(r=>r.uc===uc && r.position===pos);
      if (!rows.length) return;
      // header includes UC and Designation
      const headerTitle = `Applications for: ${pos} â€” ${uc}`;
  const headers = ["S.No","Application No","Name","Father Name","Age","CNIC","UC"];
      let extraName='';
      if (pos === 'Sanitary Worker') extraName = 'Physically Fit';
      else if (pos === 'Mechanic') extraName = 'Diploma / Specialty';
      else if (['Tractor Driver','Excavator Driver','Dumper Driver'].includes(pos)) extraName='License Type';
  if (extraName) headers.push(extraName);
  headers.push("Contact","Experience (Years)","Education","Permanent Address","Date of Submission","Remarks","Status","Reject Reason");
      const aoa = [];
      aoa.push([headerTitle]);
      aoa.push(headers);
      rows.forEach(r=>{
  const row = [r.sNo, r.appNo, r.name, r.father, r.age, formatCNICStored(r.cnic), r.uc];
        if (extraName) row.push(r.extra || '');
  row.push(formatContactStored(r.contact), `${r.experience||0} years`, r.education, r.address, r.date, r.remarks, r.status || 'Pending', r.rejectReason || '');
        aoa.push(row);
      });
      let sheetName = `${uc} - ${pos}`.slice(0,31);
      const ws = XLSX.utils.aoa_to_sheet(aoa);
      XLSX.utils.book_append_sheet(wb, ws, sheetName);
    });
  });
  const fname = `Applications_All_${new Date().toISOString().slice(0,10)}.xlsx`;
  XLSX.writeFile(wb, fname);
  showToast('success','Exported', 'Export completed: ' + fname, 2400);
}

function exportFiltered(){
  // use same filtering logic as view
  const rows = getFilteredRows();
  if (!rows.length){ showToast('info','No data','No data for selected filter'); return; }
  const groups = {};
  rows.forEach(r=>{ const key = `${r.uc}~~~${r.position}`; if (!groups[key]) groups[key]=[]; groups[key].push(r); });
  const wb = XLSX.utils.book_new();
  Object.keys(groups).forEach(k=>{
    const [ucname,posname] = k.split('~~~');
    const headerTitle = `Applications for: ${posname} â€” ${ucname}`;
    const headers = ["S.No","Application No","Name","Father Name","Age","CNIC","UC"];
    let extraName='';
    if (posname === 'Sanitary Worker') extraName = 'Physically Fit';
    else if (posname === 'Mechanic') extraName = 'Diploma / Specialty';
    else if (['Tractor Driver','Excavator Driver','Dumper Driver'].includes(posname)) extraName='License Type';
    if (extraName) headers.push(extraName);
  headers.push("Contact","Experience (Years)","Education","Permanent Address","Date of Submission","Remarks","Status","Reject Reason");
    const aoa = [];
    aoa.push([headerTitle]);
    aoa.push(headers);
      groups[k].forEach(r=>{
      const row = [r.sNo, r.appNo, r.name, r.father, r.age, formatCNICStored(r.cnic), r.uc];
      if (extraName) row.push(r.extra || '');
      row.push(formatContactStored(r.contact), `${r.experience||0} years`, r.education, r.address, r.date, r.remarks, r.status || 'Pending', r.rejectReason || '');
      aoa.push(row);
    });
    let sheetName = `${ucname} - ${posname}`.slice(0,31);
    const ws = XLSX.utils.aoa_to_sheet(aoa);
    XLSX.utils.book_append_sheet(wb, ws, sheetName);
  });
  const fname = `Applications_Filtered_${new Date().toISOString().slice(0,10)}.xlsx`;
  XLSX.writeFile(wb, fname);
  showToast('success','Exported','Filtered export complete: ' + fname, 2400);
}

// ---------- Utilities ----------
function generateId(){ return 'id-' + Math.random().toString(36).slice(2,10); }
function escapeHtml(s){ if(!s && s!==0) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

// initialize persisted data into UI on load
(function initFromStorage(){
  const stored = localStorage.getItem(STORAGE_KEY);
  if (stored) data = JSON.parse(stored);
  const cstored = localStorage.getItem(COUNTERS_KEY);
  if (cstored) counters = JSON.parse(cstored);
  // set date default
  document.getElementById('fDate').value = new Date().toLocaleDateString();
  // sequences initialization will run when user logs in and initApp() calls initSequencesFromStorage()
})();

// Charts configuration and state
let ucPieChart = null;
let designationBarChart = null;
let timelineChart = null;

// Chart colors from theme
const chartColors = {
  primary: '#1565c0',
  primaryDark: '#0d47a1',
  background: '#f7fbff'
};

// Generate color shades for charts
function generateColorShades(count) {
  return Array.from({length: count}, (_, i) => {
    const shade = Math.floor(80 - (i * (50 / count)));
    return `hsl(217, 71%, ${shade}%)`;
  });
}

// Initialize charts
function initializeCharts() {
  // Common options
  Chart.defaults.font.family = "'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, Arial";
  Chart.defaults.font.size = 12;
  
  // Create UC Pie Chart
  const ucCtx = document.getElementById('ucPieChart').getContext('2d');
  ucPieChart = new Chart(ucCtx, {
    type: 'doughnut',
    data: {
      labels: [],
      datasets: [{
        data: [],
        backgroundColor: [],
        borderWidth: 1,
        borderColor: '#fff'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'right',
          labels: { font: { size: 11 } }
        }
      }
    }
  });

  // Create Designation Bar Chart
  const desigCtx = document.getElementById('designationBarChart').getContext('2d');
  designationBarChart = new Chart(desigCtx, {
    type: 'bar',
    data: {
      labels: [],
      datasets: [{
        data: [],
        backgroundColor: chartColors.primary,
        borderColor: chartColors.primaryDark,
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: { precision: 0 }
        }
      }
    }
  });

  // Create Timeline Chart
  const timeCtx = document.getElementById('timelineChart').getContext('2d');
  timelineChart = new Chart(timeCtx, {
    type: 'line',
    data: {
      labels: [],
      datasets: [{
        label: 'Applications',
        data: [],
        borderColor: chartColors.primary,
        backgroundColor: 'rgba(21, 101, 192, 0.1)',
        fill: true,
        tension: 0.4
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: { precision: 0 }
        }
      }
    }
  });
}

// Update charts with current data
function updateCharts() {
  if (!ucPieChart || !designationBarChart || !timelineChart) return;

  // Update UC Pie Chart
  const ucData = {};
  ['DI KHAN', ...UCs].forEach(uc => {
    ucData[uc] = data.filter(d => d.uc === uc).length;
  });
  ucPieChart.data.labels = Object.keys(ucData);
  ucPieChart.data.datasets[0].data = Object.values(ucData);
  ucPieChart.data.datasets[0].backgroundColor = generateColorShades(Object.keys(ucData).length);
  ucPieChart.update();

  // Update Designation Bar Chart
  const desigData = {};
  POSITIONS.forEach(pos => {
    desigData[pos] = data.filter(d => d.position === pos).length;
  });
  designationBarChart.data.labels = Object.keys(desigData);
  designationBarChart.data.datasets[0].data = Object.values(desigData);
  designationBarChart.update();

  // Update Timeline Chart
  const timelineData = {};
  data.sort((a,b) => new Date(a.date) - new Date(b.date))
      .forEach(d => {
        const date = d.date;
        timelineData[date] = (timelineData[date] || 0) + 1;
      });
  timelineChart.data.labels = Object.keys(timelineData);
  timelineChart.data.datasets[0].data = Object.values(timelineData).map((v, i, arr) => 
    arr.slice(0, i + 1).reduce((sum, curr) => sum + curr, 0)
  );
  timelineChart.update();
}

// Hook chart updates into existing functions
const originalRenderDashboard = renderDashboard;
renderDashboard = function() {
  originalRenderDashboard();
  updateCharts();
};

// Auto-login if persistent flag is set
(function checkPersistentLogin(){
  try{
    if (localStorage.getItem('loggedIn') === 'true'){
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('app').style.display = 'block';
      // small delay to ensure DOM is ready
      setTimeout(()=> {
        initApp();
        initializeCharts();
        updateCharts();
      }, 100);
    }
  }catch(e){ /* ignore */ }
})();

// Reject modal handlers (use updateApplicantStatus for status changes)
function closeRejectModal(){ window._pendingRejectId = null; document.getElementById('rejectModal').style.display = 'none'; }
document.getElementById('confirmRejectBtn').addEventListener('click', ()=>{
  const reason = document.getElementById('rejectReasonSelect').value;
  if (!reason){ showToast('info','Select reason','Please select a reason'); return; }
  if (!window._pendingRejectId) { closeRejectModal(); return; }
  updateApplicantStatus(window._pendingRejectId, 'Rejected', reason);
  closeRejectModal();
});
</script>

</body>
</html>
